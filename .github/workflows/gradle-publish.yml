name: Generate ReVanced Patch Bundle

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate-bundle:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repozytorium
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests requests-toolbelt # requests-toolbelt jest nadal potrzebny dla retries

      # 4. Generate bundle.json directly in workflow
      - name: Generate bundle.json
        run: |
          python - << 'EOF'
          import json
          import requests
          import sys
          from requests.adapters import HTTPAdapter
          from urllib3.util.retry import Retry

          # Konfiguracja ponawiania prób
          retries = Retry(total=5,  # Całkowita liczba ponownych prób
                          backoff_factor=0.5, # Czas oczekiwania między próbami (0.5s, 1s, 2s, 4s, 8s)
                          status_forcelist=[500, 502, 503, 504], # Kody statusu, dla których ponawiać
                          allowed_methods=["GET"]) # Metody HTTP, dla których ponawiać

          adapter = HTTPAdapter(max_retries=retries)
          http = requests.Session()
          http.mount("https://", adapter)
          http.mount("http://", adapter)

          # Lista URL-i do "bundle" plików, które zawierają linki do właściwych patchy
          bundle_urls = [
              # ReVanced-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/revanced-patch-bundles/revanced-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/revanced-patch-bundles/revanced-dev-patches-bundle.json",
              
              # Inotia00-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/inotia00-patch-bundles/inotia00-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/inotia00-patch-bundles/inotia00-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/inotia00-patch-bundles/inotia00-dev-patches-bundle.json",
              
              # Anddea-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/anddea-patch-bundles/anddea-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/anddea-patch-bundles/anddea-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/anddea-patch-bundles/anddea-dev-patches-bundle.json",
              
              # Piko-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/piko-patch-bundles/piko-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/piko-patch-bundles/piko-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/piko-dev-patches-bundle.json",
              
              # BiliRoamingM-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/biliroamingm-patch-bundles/biliroamingm-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/biliroamingm-patch-bundles/biliroamingm-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/biliroamingm-patch-bundles/biliroamingm-dev-patches-bundle.json",
              
              # Slenderman00-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/slenderman00-patch-bundles/slenderman00-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/slenderman00-patch-bundles/slenderman00-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/slenderman00-patch-bundles/slenderman00-dev-patches-bundle.json",

              # Privacy-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/privacy-patch-bundles/privacy-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/privacy-patch-bundles/privacy-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/privacy-patch-bundles/privacy-dev-patches-bundle.json",

              # Experimental-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/experimental-patch-bundles/experimental-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/experimental-patch-bundles/experimental-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/experimental-patch-bundles/experimental-dev-patches-bundle.json",

              # Dropped-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/dropped-patch-bundles/dropped-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/dropped-patch-bundles/dropped-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/dropped-dev-patches-bundle.json",

              # Wchill-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/wchill-patch-bundles/wchill-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/wchill-patch-bundles/wchill-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/wchill-patch-bundles/wchill-dev-patches-bundle.json",

              # Kitadai31-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/kitadai31-patch-bundles/kitadai31-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/kitadai31-patch-bundles/kitadai31-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/kitadai31-patch-bundles/kitadai31-dev-patches-bundle.json",

              # BholeyKaBhakt-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/bholeykabhakt-patch-bundles/bholeykabhakt-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/bholeykabhakt-patch-bundles/bholeykabhakt-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/bholeykabhakt-patch-bundles/bholeykabhakt-dev-patches-bundle.json",

              # Andronedev-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/andronedev-patch-bundles/andronedev-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/andronedev-patch-bundles/andronedev-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/andronedev-patch-bundles/andronedev-dev-patches-bundle.json",

              # ReX-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/rex-patch-bundles/rex-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/rex-patch-bundles/rex-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/rex-dev-patches-bundle.json",

              # Rufusin-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/rufusin-patch-bundles/rufusin-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/rufusin-patch-bundles/rufusin-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/rufusin-dev-patches-bundle.json",

              # Twitter-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/twitter-patch-bundles/twitter-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/twitter-patch-bundles/twitter-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/twitter-dev-patches-bundle.json",

              # Wyse--Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/wyse--patch-bundles/wyse--latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/wyse--patch-bundles/wyse--stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/wyse--patch-bundles/wyse--dev-patches-bundle.json",

              # 1fexd-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/1fexd-patch-bundles/1fexd-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/1fexd-patch-bundles/1fexd-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/1fexd-patch-bundles/1fexd-dev-patches-bundle.json",

              # Whyvl-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/whyvl-patch-bundles/whyvl-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/whyvl-patch-bundles/whyvl-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/whyvl-patch-bundles/whyvl-dev-patches-bundle.json",

              # Xrogers-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/xrogers-patch-bundles/xrogers-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/xrogers-patch-bundles/xrogers-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/xrogers-patch-bundles/xrogers-dev-patches-bundle.json",

              # D4n3436-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/d4n3436-patch-bundles/d4n3436-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/d4n3436-patch-bundles/d4n3436-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/d4n3436-patch-bundles/d4n3436-dev-patches-bundle.json",

              # AyushTNM-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/ayushtnm-patch-bundles/ayushtnm-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/ayushtnm-patch-bundles/ayushtnm-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/ayushtnm-patch-bundles/ayushtnm-dev-patches-bundle.json",

              # Arsclib-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/arsclib-patch-bundles/arsclib-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/arsclib-patch-bundles/arsclib-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/arsclib-patch-bundles/arsclib-dev-patches-bundle.json",

              # LennyRBLX-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/lennyRBLX-patch-bundles/lennyRBLX-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/lennyRBLX-patch-bundles/lennyRBLX-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/lennyRBLX-patch-bundles/lennyRBLX-dev-patches-bundle.json",
              
              # Korhelyleves, Taknok, Sti-233 - Brak linków do plików JSON, pominięto
              
              # Faith001-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/faith001-patch-bundles/faith001-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/faith001-patch-bundles/faith001-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/faith001-patch-bundles/faith001-dev-patches-bundle.json",

              # Forsyth47-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/forsyth47-patch-bundles/forsyth47-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/forsyth47-patch-bundles/forsyth47-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/forsyth47-patch-bundles/forsyth47-dev-patches-bundle.json",

              # Brosssh-Patches-Bundle (poprawiony adres URL dla Dev)
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/brosssh-patch-bundles/brosssh-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/brosssh-patch-bundles/brosssh-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/brosssh-patch-bundles/brosssh-dev-patches-bundle.json", 

              # Hoo-dles-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/hoo-dles-patch-bundles/hoo-dles-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/hoo-dles-patch-bundles/hoo-dles-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/hoo-dles-patch-bundles/hoo-dles-dev-patches-bundle.json",

              # Scrazzz-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/scrazzz-patch-bundles/scrazzz-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/scrazzz-patch-bundles/scrazzz-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/scrazzz-patch-bundles/scrazzz-dev-patches-bundle.json",

              # VinceTheProgrammer-Patches-Bundle
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/vinceTheProgrammer-patch-bundles/vinceTheProgrammer-latest-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/vinceTheProgrammer-patch-bundles/vinceTheProgrammer-stable-patches-bundle.json",
              "https://raw.githubusercontent.com/Jman-Github/ReVanced-Patch-Bundles/bundles/patch-bundles/vinceTheProgrammer-patch-bundles/vinceTheProgrammer-dev-patches-bundle.json"
          ]

          all_patches = []
          successfully_fetched_bundle_urls = []
          total_patches_before_deduplication = 0

          for bundle_url in bundle_urls:
              print(f"Pobieranie listy patchy z bundle URL: {bundle_url}")
              try:
                  response = http.get(bundle_url, timeout=20) # Zwiększono timeout
                  response.raise_for_status()
                  bundle_data = response.json()
                  
                  if isinstance(bundle_data, list):
                      # Iteruj przez elementy bundle, które powinny zawierać 'url' do właściwych patchy
                      for item in bundle_data:
                          if isinstance(item, dict) and "url" in item:
                              patch_list_url = item["url"]
                              print(f"  Pobieranie właściwych patchy z: {patch_list_url}")
                              try:
                                  patch_response = http.get(patch_list_url, timeout=20)
                                  patch_response.raise_for_status()
                                  patches_from_url = patch_response.json()

                                  if isinstance(patches_from_url, list):
                                      for p in patches_from_url:
                                          if isinstance(p, dict):
                                              all_patches.append(p)
                                              total_patches_before_deduplication += 1 # Licz każdy dodany patch
                                          else:
                                              print(f"    Ostrzeżenie: Znaleziono nieprawidłowy element (nie słownik) w liście patchy z {patch_list_url}: {p}. Pomijam.", file=sys.stderr)
                                      print(f"    Pobrano {len(patches_from_url)} patchy z {patch_list_url} (po wstępnym filtrowaniu).")
                                  elif isinstance(patches_from_url, dict) and "patches" in patches_from_url:
                                      # Ensure 'patches' key contains a list
                                      if isinstance(patches_from_url["patches"], list):
                                          for p in patches_from_url["patches"]:
                                              if isinstance(p, dict):
                                                  all_patches.append(p)
                                                  total_patches_before_deduplication += 1 # Licz każdy dodany patch
                                              else:
                                                  print(f"    Ostrzeżenie: Znaleziono nieprawidłowy element (nie słownik) w liście patchy z {patch_list_url} (z klucza 'patches'): {p}. Pomijam.", file=sys.stderr)
                                          print(f"    Pobrano {len(patches_from_url['patches'])} patchy z {patch_list_url} (z klucza 'patches', po wstępnym filtrowaniu).")
                                      else:
                                          print(f"    Ostrzeżenie: Klucz 'patches' w {patch_list_url} nie zawiera listy. Zawartość: {patches_from_url['patches']}. Pomijam.", file=sys.stderr)
                                  else:
                                      print(f"    Ostrzeżenie: Nieoczekiwana struktura JSON w pliku patchy z {patch_list_url}. Oczekiwano listy lub obiektu z kluczem 'patches'.", file=sys.stderr)
                                      print(f"    Zawartość odpowiedzi (początek): {patch_response.text[:500]}...", file=sys.stderr)

                              except requests.exceptions.Timeout:
                                  print(f"    Błąd: Przekroczono czas oczekiwania podczas pobierania patchy z {patch_list_url}.", file=sys.stderr)
                              except requests.exceptions.RequestException as e:
                                  print(f"    Błąd podczas pobierania patchy z {patch_list_url}: {e}", file=sys.stderr)
                              except json.JSONDecodeError as e:
                                  print(f"    Błąd dekodowania JSON z {patch_list_url}: {e}", file=sys.stderr)
                                  print(f"    Zawartość odpowiedzi (początek): {patch_response.text[:500]}...", file=sys.stderr)
                              except Exception as e:
                                  print(f"    Wystąpił nieoczekiwany błąd podczas przetwarzania {patch_list_url}: {e}", file=sys.stderr)
                          else:
                              print(f"  Ostrzeżenie: Element w bundle {bundle_url} nie zawiera klucza 'url' lub nie jest słownikiem: {item}. Pomijam.", file=sys.stderr)
                      successfully_fetched_bundle_urls.append(bundle_url)
                  else:
                      print(f"  Ostrzeżenie: Główny bundle {bundle_url} ma nieoczekiwaną strukturę. Oczekiwano listy obiektów z kluczem 'url'.", file=sys.stderr)
                      print(f"  Zawartość odpowiedzi (początek): {response.text[:500]}...", file=sys.stderr)

              except requests.exceptions.Timeout:
                  print(f"  Błąd: Przekroczono czas oczekiwania podczas pobierania bundle z {bundle_url}.", file=sys.stderr)
              except requests.exceptions.RequestException as e:
                  print(f"  Błąd podczas pobierania bundle z {bundle_url}: {e}", file=sys.stderr)
              except json.JSONDecodeError as e:
                  print(f"  Błąd dekodowania JSON z bundle {bundle_url}: {e}", file=sys.stderr)
                  print(f"  Zawartość odpowiedzi (początek): {response.text[:500]}...", file=sys.stderr)
              except Exception as e:
                  print(f"  Wystąpił nieoczekiwany błąd podczas przetwarzania bundle {bundle_url}: {e}", file=sys.stderr)

          # Usunięto deduplikację, aby upewnić się, że wszystkie patche są dodawane.
          # Jeśli potrzebujesz deduplikacji, musisz zdefiniować naprawdę unikalny klucz dla patchy.
          final_patches_list = all_patches
          
          # Przygotowanie finalnego bundle
          bundles = {
              "version": "1.0",
              "patches": final_patches_list
          }

          # Zapis do bundles.json
          with open("bundlesx.json", "w", encoding="utf-8") as f:
              json.dump(bundles, f, ensure_ascii=False, indent=2)
          
          # Dodaj log, aby sprawdzić, ile patchy zostało zapisanych
          print(f"\n--- Podsumowanie ---")
          print(f"Pomyślnie pobrano dane z {len(successfully_fetched_bundle_urls)}/{len(bundle_urls)} głównych źródeł bundle.")
          print(f"Zapisano łącznie {len(final_patches_list)} patchy do bundles.json (przed de-duplikacją było {total_patches_before_deduplication}).")
          if len(successfully_fetched_bundle_urls) < len(bundle_urls):
              print("Niektóre główne URL-e bundle mogły się nie powieść lub miały nieoczekiwaną strukturę. Sprawdź logi powyżej.")

          EOF

      # 5. Commit & push generated bundle.json
      - name: Commit bundles.json
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add bundlesx.json
          git commit -m "Update bundles.json [ci skip]" || echo "No changes to commit"
          git push
